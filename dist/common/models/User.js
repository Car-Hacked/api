"use strict";

var _mongoose = _interopRequireDefault(require("mongoose"));

var _bcrypt = _interopRequireDefault(require("bcrypt"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const UserSchema = new _mongoose.default.Schema({
  username: {
    type: String,
    unique: true,
    required: true,
    trim: true
  },
  password: {
    type: String,
    required: true
  }
}, {
  timestamps: true
});

UserSchema.statics.authenticate = async function (Username, password) {
  let user = await this.findOne({
    username: Username
  });

  if (user) {
    const match = await _bcrypt.default.compare(password, user.password);

    if (match === true) {
      user = await user.populate('currentDay').execPopulate().catch(error => error);
      if (user instanceof Error) return user;
      return user;
    }

    let error = new Error('Invalid credentials');
    error.code = 'INVALID_CREDS';
    return error;
  }
};

UserSchema.pre('save', async function (next) {
  if (this.password.length !== 60) {
    let hash = await _bcrypt.default.hash(this.password, 10).catch(err => err);

    if (hash instanceof Error) {
      return next(hash);
    }

    this.password = hash;
    return next();
  }

  return next();
});
module.exports.User = _mongoose.default.model('User', UserSchema);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9jb21tb24vbW9kZWxzL1VzZXIuanMiXSwibmFtZXMiOlsiVXNlclNjaGVtYSIsIm1vbmdvb3NlIiwiU2NoZW1hIiwidXNlcm5hbWUiLCJ0eXBlIiwiU3RyaW5nIiwidW5pcXVlIiwicmVxdWlyZWQiLCJ0cmltIiwicGFzc3dvcmQiLCJ0aW1lc3RhbXBzIiwic3RhdGljcyIsImF1dGhlbnRpY2F0ZSIsIlVzZXJuYW1lIiwidXNlciIsImZpbmRPbmUiLCJtYXRjaCIsImJjcnlwdCIsImNvbXBhcmUiLCJwb3B1bGF0ZSIsImV4ZWNQb3B1bGF0ZSIsImNhdGNoIiwiZXJyb3IiLCJFcnJvciIsImNvZGUiLCJwcmUiLCJuZXh0IiwibGVuZ3RoIiwiaGFzaCIsImVyciIsIm1vZHVsZSIsImV4cG9ydHMiLCJVc2VyIiwibW9kZWwiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxVQUFVLEdBQUcsSUFBSUMsa0JBQVNDLE1BQWIsQ0FBb0I7QUFDbkNDLEVBQUFBLFFBQVEsRUFBRTtBQUNOQyxJQUFBQSxJQUFJLEVBQUVDLE1BREE7QUFFTkMsSUFBQUEsTUFBTSxFQUFFLElBRkY7QUFHTkMsSUFBQUEsUUFBUSxFQUFFLElBSEo7QUFJTkMsSUFBQUEsSUFBSSxFQUFFO0FBSkEsR0FEeUI7QUFPbkNDLEVBQUFBLFFBQVEsRUFBRTtBQUNOTCxJQUFBQSxJQUFJLEVBQUVDLE1BREE7QUFFTkUsSUFBQUEsUUFBUSxFQUFFO0FBRko7QUFQeUIsQ0FBcEIsRUFXaEI7QUFBRUcsRUFBQUEsVUFBVSxFQUFFO0FBQWQsQ0FYZ0IsQ0FBbkI7O0FBYUFWLFVBQVUsQ0FBQ1csT0FBWCxDQUFtQkMsWUFBbkIsR0FBa0MsZ0JBQWdCQyxRQUFoQixFQUEwQkosUUFBMUIsRUFBb0M7QUFDbEUsTUFBSUssSUFBSSxHQUFHLE1BQU0sS0FBS0MsT0FBTCxDQUFhO0FBQUVaLElBQUFBLFFBQVEsRUFBRVU7QUFBWixHQUFiLENBQWpCOztBQUNBLE1BQUlDLElBQUosRUFBVTtBQUNOLFVBQU1FLEtBQUssR0FBRyxNQUFNQyxnQkFBT0MsT0FBUCxDQUFlVCxRQUFmLEVBQXlCSyxJQUFJLENBQUNMLFFBQTlCLENBQXBCOztBQUNBLFFBQUlPLEtBQUssS0FBSyxJQUFkLEVBQW9CO0FBQ2hCRixNQUFBQSxJQUFJLEdBQUcsTUFBTUEsSUFBSSxDQUFDSyxRQUFMLENBQWMsWUFBZCxFQUE0QkMsWUFBNUIsR0FBMkNDLEtBQTNDLENBQWlEQyxLQUFLLElBQUlBLEtBQTFELENBQWI7QUFDQSxVQUFJUixJQUFJLFlBQVlTLEtBQXBCLEVBQTJCLE9BQU9ULElBQVA7QUFDM0IsYUFBT0EsSUFBUDtBQUNIOztBQUNELFFBQUlRLEtBQUssR0FBRyxJQUFJQyxLQUFKLENBQVUscUJBQVYsQ0FBWjtBQUNBRCxJQUFBQSxLQUFLLENBQUNFLElBQU4sR0FBYSxlQUFiO0FBQ0EsV0FBT0YsS0FBUDtBQUNIO0FBQ0osQ0FiRDs7QUFlQXRCLFVBQVUsQ0FBQ3lCLEdBQVgsQ0FBZSxNQUFmLEVBQXVCLGdCQUFnQkMsSUFBaEIsRUFBc0I7QUFDekMsTUFBSSxLQUFLakIsUUFBTCxDQUFja0IsTUFBZCxLQUF5QixFQUE3QixFQUFpQztBQUM3QixRQUFJQyxJQUFJLEdBQUcsTUFBTVgsZ0JBQU9XLElBQVAsQ0FBWSxLQUFLbkIsUUFBakIsRUFBMkIsRUFBM0IsRUFBK0JZLEtBQS9CLENBQXFDUSxHQUFHLElBQUlBLEdBQTVDLENBQWpCOztBQUNBLFFBQUlELElBQUksWUFBWUwsS0FBcEIsRUFBMkI7QUFDdkIsYUFBT0csSUFBSSxDQUFDRSxJQUFELENBQVg7QUFDSDs7QUFDRCxTQUFLbkIsUUFBTCxHQUFnQm1CLElBQWhCO0FBQ0EsV0FBT0YsSUFBSSxFQUFYO0FBQ0g7O0FBQ0QsU0FBT0EsSUFBSSxFQUFYO0FBQ0gsQ0FWRDtBQVlBSSxNQUFNLENBQUNDLE9BQVAsQ0FBZUMsSUFBZixHQUFzQi9CLGtCQUFTZ0MsS0FBVCxDQUFlLE1BQWYsRUFBdUJqQyxVQUF2QixDQUF0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XG5pbXBvcnQgYmNyeXB0IGZyb20gJ2JjcnlwdCc7XG5cbmNvbnN0IFVzZXJTY2hlbWEgPSBuZXcgbW9uZ29vc2UuU2NoZW1hKHtcbiAgICB1c2VybmFtZToge1xuICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgIHVuaXF1ZTogdHJ1ZSxcbiAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgIHRyaW06IHRydWUsXG4gICAgfSxcbiAgICBwYXNzd29yZDoge1xuICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgIH1cbn0sIHsgdGltZXN0YW1wczogdHJ1ZSB9KTtcblxuVXNlclNjaGVtYS5zdGF0aWNzLmF1dGhlbnRpY2F0ZSA9IGFzeW5jIGZ1bmN0aW9uIChVc2VybmFtZSwgcGFzc3dvcmQpIHtcbiAgICBsZXQgdXNlciA9IGF3YWl0IHRoaXMuZmluZE9uZSh7IHVzZXJuYW1lOiBVc2VybmFtZSB9KTtcbiAgICBpZiAodXNlcikge1xuICAgICAgICBjb25zdCBtYXRjaCA9IGF3YWl0IGJjcnlwdC5jb21wYXJlKHBhc3N3b3JkLCB1c2VyLnBhc3N3b3JkKTtcbiAgICAgICAgaWYgKG1hdGNoID09PSB0cnVlKSB7XG4gICAgICAgICAgICB1c2VyID0gYXdhaXQgdXNlci5wb3B1bGF0ZSgnY3VycmVudERheScpLmV4ZWNQb3B1bGF0ZSgpLmNhdGNoKGVycm9yID0+IGVycm9yKTtcbiAgICAgICAgICAgIGlmICh1c2VyIGluc3RhbmNlb2YgRXJyb3IpIHJldHVybiB1c2VyO1xuICAgICAgICAgICAgcmV0dXJuIHVzZXI7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGVycm9yID0gbmV3IEVycm9yKCdJbnZhbGlkIGNyZWRlbnRpYWxzJyk7XG4gICAgICAgIGVycm9yLmNvZGUgPSAnSU5WQUxJRF9DUkVEUyc7XG4gICAgICAgIHJldHVybiBlcnJvcjtcbiAgICB9XG59O1xuXG5Vc2VyU2NoZW1hLnByZSgnc2F2ZScsIGFzeW5jIGZ1bmN0aW9uIChuZXh0KSB7XG4gICAgaWYgKHRoaXMucGFzc3dvcmQubGVuZ3RoICE9PSA2MCkge1xuICAgICAgICBsZXQgaGFzaCA9IGF3YWl0IGJjcnlwdC5oYXNoKHRoaXMucGFzc3dvcmQsIDEwKS5jYXRjaChlcnIgPT4gZXJyKTtcbiAgICAgICAgaWYgKGhhc2ggaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoaGFzaCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wYXNzd29yZCA9IGhhc2g7XG4gICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgfVxuICAgIHJldHVybiBuZXh0KCk7XG59KTtcblxubW9kdWxlLmV4cG9ydHMuVXNlciA9IG1vbmdvb3NlLm1vZGVsKCdVc2VyJywgVXNlclNjaGVtYSk7XG4iXX0=