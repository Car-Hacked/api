"use strict";

var _mongoose = _interopRequireDefault(require("mongoose"));

var _moment = _interopRequireDefault(require("moment"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const AccessToken = new _mongoose.default.Schema({
  token: {
    type: String,
    unique: true,
    required: true
  },
  user: {
    type: _mongoose.default.Schema.Types.ObjectId,
    ref: 'User',
    unique: true,
    required: true
  },
  expireAt: {
    type: Date,
    default: () => (0, _moment.default)().add(10, 'hours'),
    expires: 60
  }
}, {
  timestamps: true
});
AccessToken.pre('save', function (next) {
  this.constructor.findOne({
    user: this.user
  }, (err, storedToken) => {
    if (err) {
      return next(err);
    } else if (!storedToken) {
      // do nothing, that means there is no old token to delete.
      return next();
    }

    return storedToken.remove(err => {
      if (err) return next(err);
      return next();
    });
  });
});
module.exports = _mongoose.default.model('AccessToken', AccessToken);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9jb21tb24vbW9kZWxzL0FjY2Vzc1Rva2VuLmpzIl0sIm5hbWVzIjpbIkFjY2Vzc1Rva2VuIiwibW9uZ29vc2UiLCJTY2hlbWEiLCJ0b2tlbiIsInR5cGUiLCJTdHJpbmciLCJ1bmlxdWUiLCJyZXF1aXJlZCIsInVzZXIiLCJUeXBlcyIsIk9iamVjdElkIiwicmVmIiwiZXhwaXJlQXQiLCJEYXRlIiwiZGVmYXVsdCIsImFkZCIsImV4cGlyZXMiLCJ0aW1lc3RhbXBzIiwicHJlIiwibmV4dCIsImNvbnN0cnVjdG9yIiwiZmluZE9uZSIsImVyciIsInN0b3JlZFRva2VuIiwicmVtb3ZlIiwibW9kdWxlIiwiZXhwb3J0cyIsIm1vZGVsIl0sIm1hcHBpbmdzIjoiOztBQUFBOztBQUNBOzs7O0FBRUEsTUFBTUEsV0FBVyxHQUFHLElBQUlDLGtCQUFTQyxNQUFiLENBQW9CO0FBQ3BDQyxFQUFBQSxLQUFLLEVBQUU7QUFDSEMsSUFBQUEsSUFBSSxFQUFFQyxNQURIO0FBRUhDLElBQUFBLE1BQU0sRUFBRSxJQUZMO0FBR0hDLElBQUFBLFFBQVEsRUFBRTtBQUhQLEdBRDZCO0FBTXBDQyxFQUFBQSxJQUFJLEVBQUU7QUFDRkosSUFBQUEsSUFBSSxFQUFFSCxrQkFBU0MsTUFBVCxDQUFnQk8sS0FBaEIsQ0FBc0JDLFFBRDFCO0FBRUZDLElBQUFBLEdBQUcsRUFBRSxNQUZIO0FBR0ZMLElBQUFBLE1BQU0sRUFBRSxJQUhOO0FBSUZDLElBQUFBLFFBQVEsRUFBRTtBQUpSLEdBTjhCO0FBWXBDSyxFQUFBQSxRQUFRLEVBQUU7QUFDTlIsSUFBQUEsSUFBSSxFQUFFUyxJQURBO0FBRU5DLElBQUFBLE9BQU8sRUFBRSxNQUFNLHVCQUFTQyxHQUFULENBQWEsRUFBYixFQUFpQixPQUFqQixDQUZUO0FBR05DLElBQUFBLE9BQU8sRUFBRTtBQUhIO0FBWjBCLENBQXBCLEVBaUJqQjtBQUFFQyxFQUFBQSxVQUFVLEVBQUU7QUFBZCxDQWpCaUIsQ0FBcEI7QUFtQkFqQixXQUFXLENBQUNrQixHQUFaLENBQWdCLE1BQWhCLEVBQXdCLFVBQVVDLElBQVYsRUFBZ0I7QUFDcEMsT0FBS0MsV0FBTCxDQUFpQkMsT0FBakIsQ0FBeUI7QUFBRWIsSUFBQUEsSUFBSSxFQUFFLEtBQUtBO0FBQWIsR0FBekIsRUFBOEMsQ0FBQ2MsR0FBRCxFQUFNQyxXQUFOLEtBQXNCO0FBQ2hFLFFBQUlELEdBQUosRUFBUztBQUNMLGFBQU9ILElBQUksQ0FBQ0csR0FBRCxDQUFYO0FBQ0gsS0FGRCxNQUVPLElBQUksQ0FBQ0MsV0FBTCxFQUFrQjtBQUNyQjtBQUNBLGFBQU9KLElBQUksRUFBWDtBQUNIOztBQUNELFdBQU9JLFdBQVcsQ0FBQ0MsTUFBWixDQUFtQkYsR0FBRyxJQUFJO0FBQzdCLFVBQUlBLEdBQUosRUFBUyxPQUFPSCxJQUFJLENBQUNHLEdBQUQsQ0FBWDtBQUNULGFBQU9ILElBQUksRUFBWDtBQUNILEtBSE0sQ0FBUDtBQUlILEdBWEQ7QUFZSCxDQWJEO0FBZUFNLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnpCLGtCQUFTMEIsS0FBVCxDQUFlLGFBQWYsRUFBOEIzQixXQUE5QixDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCc7XG5cbmNvbnN0IEFjY2Vzc1Rva2VuID0gbmV3IG1vbmdvb3NlLlNjaGVtYSh7XG4gICAgdG9rZW46IHtcbiAgICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgICB1bmlxdWU6IHRydWUsXG4gICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgIH0sXG4gICAgdXNlcjoge1xuICAgICAgICB0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsXG4gICAgICAgIHJlZjogJ1VzZXInLFxuICAgICAgICB1bmlxdWU6IHRydWUsXG4gICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgIH0sXG4gICAgZXhwaXJlQXQ6IHtcbiAgICAgICAgdHlwZTogRGF0ZSxcbiAgICAgICAgZGVmYXVsdDogKCkgPT4gbW9tZW50KCkuYWRkKDEwLCAnaG91cnMnKSxcbiAgICAgICAgZXhwaXJlczogNjAsXG4gICAgfSxcbn0sIHsgdGltZXN0YW1wczogdHJ1ZSB9KTtcblxuQWNjZXNzVG9rZW4ucHJlKCdzYXZlJywgZnVuY3Rpb24gKG5leHQpIHtcbiAgICB0aGlzLmNvbnN0cnVjdG9yLmZpbmRPbmUoeyB1c2VyOiB0aGlzLnVzZXIgfSwgKGVyciwgc3RvcmVkVG9rZW4pID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoZXJyKTtcbiAgICAgICAgfSBlbHNlIGlmICghc3RvcmVkVG9rZW4pIHtcbiAgICAgICAgICAgIC8vIGRvIG5vdGhpbmcsIHRoYXQgbWVhbnMgdGhlcmUgaXMgbm8gb2xkIHRva2VuIHRvIGRlbGV0ZS5cbiAgICAgICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN0b3JlZFRva2VuLnJlbW92ZShlcnIgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIG5leHQoZXJyKTtcbiAgICAgICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gbW9uZ29vc2UubW9kZWwoJ0FjY2Vzc1Rva2VuJywgQWNjZXNzVG9rZW4pOyJdfQ==