"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Controller = void 0;

var _users = _interopRequireDefault(require("../../services/users/users.service"));

var _me = _interopRequireDefault(require("../../services/me.service"));

var _AccessToken = _interopRequireDefault(require("../../../common/models/AccessToken"));

var _User = require("../../../common/models/User");

var _logger = _interopRequireDefault(require("../../../common/logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Controller {
  create(req, res) {
    _logger.default.info('UsersService.create()');

    if (req.body && req.body.username && req.body.username.length > 20 && req.body.password && req.body.password.length > 20 && req.body.secret && req.body.secret.length > 20) {
      return res.status(422).json({
        error: 'One of the parameters is too long! Keep under 20 characters!',
        code: 'TOO_LONG'
      });
    }

    if (req.body && req.body.username && req.body.password && req.body.secret) {
      const usernameRegex = /^[a-z0-9_]+$/i;

      if (req.body.secret !== process.env.SERVER_SECRET) {
        return res.status(401).json({
          error: 'Invalid credentials',
          code: 'NOT_AUTH'
        });
      }

      if (usernameRegex.test(req.body.username)) {
        return _users.default.create(req.body).then(r => {
          if (r.message && r.message.slice(0, 6) === 'E11000') {
            return res.status(409).json({
              error: 'Username already exists!',
              code: 'ALREADY_EXISTS'
            });
          } else if (r instanceof Error) {
            _logger.default.error(r);

            return res.status(500).json({
              error: 'An internal server error occured!',
              code: 'INTERNAL'
            });
          }

          return res.status(201).json(r);
        });
      }

      return res.status(422).json({
        error: 'Username is invalid! Only alphanumeric characters and unserscore allowed!',
        code: 'INVALID_USERNAME'
      });
    }

    return res.status(422).json({
      error: 'Missing required parameter.',
      code: 'INVALID_PARAMS'
    });
  }

  async remove(req, res) {
    _logger.default.info(`UsersService.remove(${req.body.id})`);

    if (req.body && req.body.id) {
      if (req.headers.accesstoken || req.cookies.accesstoken) {
        let result = await _me.default.me(req, res);

        if (result instanceof Error && 'code' in result && result.code === 'NOT_AUTH') {
          return res.status(401).json(result);
        } else if (result instanceof Error) {
          _logger.default.error(result);

          return res.status(500).json({
            error: 'An internal server error occured!',
            code: 'INTERNAL'
          });
        }

        let copy = result.toObject();
        delete copy.password;

        if (result._id.toString() !== req.body.id) {
          let error = new Error(`User does not have access to delete user with id: ${req.body.id}`);
          error.error = `User does not have access to delete user with id: ${req.body.id}`;
          error.code = 'FORBIDDEN';
          return res.status(403).json(error);
        }

        let secondResult = await _User.User.remove({
          _id: result._id
        }).catch(error => error);

        if (secondResult instanceof Error) {
          if ('code' in secondResult && secondResult.code === 'NOT_EXIST') {
            return res.status(404).json({
              error: secondResult.error,
              code: secondResult.code
            });
          }

          _logger.default.error(result);

          return res.status(500).json({
            error: 'An internal server error occured!',
            code: 'INTERNAL'
          });
        }

        await _AccessToken.default.deleteOne({
          user: copy._id
        });
        let response = {
          message: `User with id of ${copy._id} and all associated data successfully removed!`,
          code: 'REMOVED'
        };
        return res.status(200).json(response);
      }

      return res.status(401).json({
        error: 'Missing required header accessToken.',
        code: 'NOT_AUTH'
      });
    }

    return res.status(422).json({
      error: 'Missing required parameter.',
      code: 'INVALID_PARAMS'
    });
  }

  async update(req, res) {
    _logger.default.info('UsersService.update()');

    const usernameRegex = /^[a-z0-9_]+$/i;

    if (req.body && (req.body.username && req.body.username.length > 20 || req.body.password && req.body.password.length > 20)) {
      return res.status(422).json({
        error: 'One of the parameters is too long! Keep under 20 characters!',
        code: 'TOO_LONG'
      });
    }

    if (req.body && (req.body.username || req.body.password)) {
      if (req.headers.accesstoken || req.cookies.accesstoken) {
        let result = await _me.default.me(req, res);

        if (result instanceof Error && 'code' in result && result.code === 'NOT_AUTH') {
          return res.status(401).json(result);
        } else if (result instanceof Error) {
          _logger.default.error(result);

          return res.status(500).json({
            error: 'An internal server error occured!',
            code: 'INTERNAL'
          });
        }

        if (req.body.username) {
          if (!usernameRegex.test(req.body.username)) {
            return res.status(422).json({
              error: 'Username is invalid! Only alphanumeric characters and unserscore allowed!',
              code: 'INVALID_USERNAME'
            });
          }

          result.username = req.body.username;
        }

        if (req.body.password) result.password = req.body.password;
        let secondResult = await result.save().catch(error => error);

        if (secondResult instanceof Error) {
          if ('code' in secondResult && secondResult.code === 'NOT_EXIST') {
            return res.status(404).json({
              error: secondResult.error,
              code: secondResult.code
            });
          }

          _logger.default.error(result);

          return res.status(500).json({
            error: 'An internal server error occured!',
            code: 'INTERNAL'
          });
        }

        if (secondResult instanceof Error) {
          return secondResult;
        }

        let copy = secondResult.toObject();
        delete copy.password;
        return res.status(200).json(copy);
      }

      return res.status(401).json({
        error: 'Missing required header accessToken.',
        code: 'NOT_AUTH'
      });
    }

    return res.status(422).json({
      error: 'Missing required parameter.',
      code: 'INVALID_PARAMS'
    });
  }

}

exports.Controller = Controller;

var _default = new Controller();

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NlcnZlci9hcGkvY29udHJvbGxlcnMvdXNlcnMvY29udHJvbGxlci5qcyJdLCJuYW1lcyI6WyJDb250cm9sbGVyIiwiY3JlYXRlIiwicmVxIiwicmVzIiwibCIsImluZm8iLCJib2R5IiwidXNlcm5hbWUiLCJsZW5ndGgiLCJwYXNzd29yZCIsInNlY3JldCIsInN0YXR1cyIsImpzb24iLCJlcnJvciIsImNvZGUiLCJ1c2VybmFtZVJlZ2V4IiwicHJvY2VzcyIsImVudiIsIlNFUlZFUl9TRUNSRVQiLCJ0ZXN0IiwiVXNlcnNTZXJ2aWNlIiwidGhlbiIsInIiLCJtZXNzYWdlIiwic2xpY2UiLCJFcnJvciIsInJlbW92ZSIsImlkIiwiaGVhZGVycyIsImFjY2Vzc3Rva2VuIiwiY29va2llcyIsInJlc3VsdCIsIk1lU2VydmljZSIsIm1lIiwiY29weSIsInRvT2JqZWN0IiwiX2lkIiwidG9TdHJpbmciLCJzZWNvbmRSZXN1bHQiLCJVc2VyIiwiY2F0Y2giLCJUb2tlbiIsImRlbGV0ZU9uZSIsInVzZXIiLCJyZXNwb25zZSIsInVwZGF0ZSIsInNhdmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVPLE1BQU1BLFVBQU4sQ0FBaUI7QUFFcEJDLEVBQUFBLE1BQU0sQ0FBQ0MsR0FBRCxFQUFNQyxHQUFOLEVBQVc7QUFDYkMsb0JBQUVDLElBQUYsQ0FBTyx1QkFBUDs7QUFDQSxRQUFJSCxHQUFHLENBQUNJLElBQUosSUFDRUosR0FBRyxDQUFDSSxJQUFKLENBQVNDLFFBQVQsSUFBcUJMLEdBQUcsQ0FBQ0ksSUFBSixDQUFTQyxRQUFULENBQWtCQyxNQUFsQixHQUEyQixFQUFqRCxJQUNJTixHQUFHLENBQUNJLElBQUosQ0FBU0csUUFBVCxJQUFxQlAsR0FBRyxDQUFDSSxJQUFKLENBQVNHLFFBQVQsQ0FBa0JELE1BQWxCLEdBQTJCLEVBRHBELElBQzRETixHQUFHLENBQUNJLElBQUosQ0FB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LENBQ0ssR0FETCxFQUVGQyxJQUZFLENBRUc7QUFBRUMsY0FBQUEsS0FBSyxFQUFFeUIsWUFBWSxDQUFDekIsS0FBdEI7QUFBNkJDLGNBQUFBLElBQUksRUFBRXdCLFlBQVksQ0FBQ3hCO0FBQWhELGFBRkgsQ0FBUDtBQUdIOztBQUNEViwwQkFBRVMsS0FBRixDQUFRa0IsTUFBUjs7QUFDQSxpQkFBTzVCLEdBQUcsQ0FDTFEsTUFERSxDQUNLLEdBREwsRUFFRkMsSUFGRSxDQUVHO0FBQUVDLFlBQUFBLEtBQUssRUFBRSxtQ0FBVDtBQUE4Q0MsWUFBQUEsSUFBSSxFQUFFO0FBQXBELFdBRkgsQ0FBUDtBQUdIOztBQUNELFlBQUl3QixZQUFZLFlBQVliLEtBQTVCLEVBQW1DO0FBQy9CLGlCQUFPYSxZQUFQO0FBQ0g7O0FBQ0QsWUFBSUosSUFBSSxHQUFHSSxZQUFZLENBQUNILFFBQWIsRUFBWDtBQUNBLGVBQU9ELElBQUksQ0FBQ3pCLFFBQVo7QUFDQSxlQUFPTixHQUFHLENBQUNRLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQnNCLElBQXJCLENBQVA7QUFDSDs7QUFDRCxhQUFPL0IsR0FBRyxDQUNMUSxNQURFLENBQ0ssR0FETCxFQUVGQyxJQUZFLENBRUc7QUFBRUMsUUFBQUEsS0FBSyxFQUFFLHNDQUFUO0FBQWlEQyxRQUFBQSxJQUFJLEVBQUU7QUFBdkQsT0FGSCxDQUFQO0FBR0g7O0FBQ0QsV0FBT1gsR0FBRyxDQUNMUSxNQURFLENBQ0ssR0FETCxFQUVGQyxJQUZFLENBRUc7QUFBRUMsTUFBQUEsS0FBSyxFQUFFLDZCQUFUO0FBQXdDQyxNQUFBQSxJQUFJLEVBQUU7QUFBOUMsS0FGSCxDQUFQO0FBR0g7O0FBM0ptQjs7OztlQTZKVCxJQUFJZCxVQUFKLEUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVXNlcnNTZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL3VzZXJzL3VzZXJzLnNlcnZpY2UnO1xuaW1wb3J0IE1lU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9tZS5zZXJ2aWNlJztcbmltcG9ydCBUb2tlbiBmcm9tICcuLi8uLi8uLi9jb21tb24vbW9kZWxzL0FjY2Vzc1Rva2VuJztcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vbW9kZWxzL1VzZXInO1xuaW1wb3J0IGwgZnJvbSAnLi4vLi4vLi4vY29tbW9uL2xvZ2dlcic7XG5cbmV4cG9ydCBjbGFzcyBDb250cm9sbGVyIHtcblxuICAgIGNyZWF0ZShyZXEsIHJlcykge1xuICAgICAgICBsLmluZm8oJ1VzZXJzU2VydmljZS5jcmVhdGUoKScpO1xuICAgICAgICBpZiAocmVxLmJvZHkgJiZcbiAgICAgICAgICAgICgocmVxLmJvZHkudXNlcm5hbWUgJiYgcmVxLmJvZHkudXNlcm5hbWUubGVuZ3RoID4gMjApICYmXG4gICAgICAgICAgICAgICAgKHJlcS5ib2R5LnBhc3N3b3JkICYmIHJlcS5ib2R5LnBhc3N3b3JkLmxlbmd0aCA+IDIwKSAmJiAocmVxLmJvZHkuc2VjcmV0ICYmIHJlcS5ib2R5LnNlY3JldC5sZW5ndGggPiAyMCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzXG4gICAgICAgICAgICAgICAgLnN0YXR1cyg0MjIpXG4gICAgICAgICAgICAgICAgLmpzb24oeyBlcnJvcjogJ09uZSBvZiB0aGUgcGFyYW1ldGVycyBpcyB0b28gbG9uZyEgS2VlcCB1bmRlciAyMCBjaGFyYWN0ZXJzIScsIGNvZGU6ICdUT09fTE9ORycgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlcS5ib2R5ICYmXG4gICAgICAgICAgICByZXEuYm9keS51c2VybmFtZSAmJlxuICAgICAgICAgICAgcmVxLmJvZHkucGFzc3dvcmQgJiZcbiAgICAgICAgICAgIHJlcS5ib2R5LnNlY3JldCkge1xuICAgICAgICAgICAgY29uc3QgdXNlcm5hbWVSZWdleCA9IC9eW2EtejAtOV9dKyQvaTtcbiAgICAgICAgICAgIGlmIChyZXEuYm9keS5zZWNyZXQgIT09IHByb2Nlc3MuZW52LlNFUlZFUl9TRUNSRVQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzXG4gICAgICAgICAgICAgICAgICAgIC5zdGF0dXMoNDAxKVxuICAgICAgICAgICAgICAgICAgICAuanNvbih7IGVycm9yOiAnSW52YWxpZCBjcmVkZW50aWFscycsIGNvZGU6ICdOT1RfQVVUSCcgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodXNlcm5hbWVSZWdleC50ZXN0KHJlcS5ib2R5LnVzZXJuYW1lKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBVc2Vyc1NlcnZpY2VcbiAgICAgICAgICAgICAgICAgICAgLmNyZWF0ZShyZXEuYm9keSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4ociA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoci5tZXNzYWdlICYmIChyLm1lc3NhZ2Uuc2xpY2UoMCwgNikgPT09ICdFMTEwMDAnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnN0YXR1cyg0MDkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5qc29uKHsgZXJyb3I6ICdVc2VybmFtZSBhbHJlYWR5IGV4aXN0cyEnLCBjb2RlOiAnQUxSRUFEWV9FWElTVFMnIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsLmVycm9yKHIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnN0YXR1cyg1MDApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5qc29uKHsgZXJyb3I6ICdBbiBpbnRlcm5hbCBzZXJ2ZXIgZXJyb3Igb2NjdXJlZCEnLCBjb2RlOiAnSU5URVJOQUwnIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zdGF0dXMoMjAxKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5qc29uKHIpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXNcbiAgICAgICAgICAgICAgICAuc3RhdHVzKDQyMilcbiAgICAgICAgICAgICAgICAuanNvbih7IGVycm9yOiAnVXNlcm5hbWUgaXMgaW52YWxpZCEgT25seSBhbHBoYW51bWVyaWMgY2hhcmFjdGVycyBhbmQgdW5zZXJzY29yZSBhbGxvd2VkIScsIGNvZGU6ICdJTlZBTElEX1VTRVJOQU1FJyB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzXG4gICAgICAgICAgICAuc3RhdHVzKDQyMilcbiAgICAgICAgICAgIC5qc29uKHsgZXJyb3I6ICdNaXNzaW5nIHJlcXVpcmVkIHBhcmFtZXRlci4nLCBjb2RlOiAnSU5WQUxJRF9QQVJBTVMnIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHJlbW92ZShyZXEsIHJlcykge1xuICAgICAgICBsLmluZm8oYFVzZXJzU2VydmljZS5yZW1vdmUoJHtyZXEuYm9keS5pZH0pYCk7XG4gICAgICAgIGlmIChyZXEuYm9keSAmJiByZXEuYm9keS5pZCkge1xuICAgICAgICAgICAgaWYgKHJlcS5oZWFkZXJzLmFjY2Vzc3Rva2VuIHx8IHJlcS5jb29raWVzLmFjY2Vzc3Rva2VuKSB7XG4gICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IE1lU2VydmljZS5tZShyZXEsIHJlcyk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIEVycm9yICYmICdjb2RlJyBpbiByZXN1bHQgJiYgcmVzdWx0LmNvZGUgPT09ICdOT1RfQVVUSCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBsLmVycm9yKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zdGF0dXMoNTAwKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmpzb24oeyBlcnJvcjogJ0FuIGludGVybmFsIHNlcnZlciBlcnJvciBvY2N1cmVkIScsIGNvZGU6ICdJTlRFUk5BTCcgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBjb3B5ID0gcmVzdWx0LnRvT2JqZWN0KCk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGNvcHkucGFzc3dvcmQ7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5faWQudG9TdHJpbmcoKSAhPT0gcmVxLmJvZHkuaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVycm9yID0gbmV3IEVycm9yKGBVc2VyIGRvZXMgbm90IGhhdmUgYWNjZXNzIHRvIGRlbGV0ZSB1c2VyIHdpdGggaWQ6ICR7cmVxLmJvZHkuaWR9YCk7XG4gICAgICAgICAgICAgICAgICAgIGVycm9yLmVycm9yID0gYFVzZXIgZG9lcyBub3QgaGF2ZSBhY2Nlc3MgdG8gZGVsZXRlIHVzZXIgd2l0aCBpZDogJHtyZXEuYm9keS5pZH1gO1xuICAgICAgICAgICAgICAgICAgICBlcnJvci5jb2RlID0gJ0ZPUkJJRERFTic7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbihlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBzZWNvbmRSZXN1bHQgPSBhd2FpdCBVc2VyXG4gICAgICAgICAgICAgICAgICAgIC5yZW1vdmUoeyBfaWQ6IHJlc3VsdC5faWQgfSlcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGVycm9yID0+IGVycm9yKTtcbiAgICAgICAgICAgICAgICBpZiAoc2Vjb25kUmVzdWx0IGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCdjb2RlJyBpbiBzZWNvbmRSZXN1bHQgJiYgc2Vjb25kUmVzdWx0LmNvZGUgPT09ICdOT1RfRVhJU1QnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnN0YXR1cyg0MDQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmpzb24oeyBlcnJvcjogc2Vjb25kUmVzdWx0LmVycm9yLCBjb2RlOiBzZWNvbmRSZXN1bHQuY29kZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBsLmVycm9yKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zdGF0dXMoNTAwKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmpzb24oeyBlcnJvcjogJ0FuIGludGVybmFsIHNlcnZlciBlcnJvciBvY2N1cmVkIScsIGNvZGU6ICdJTlRFUk5BTCcgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGF3YWl0IFRva2VuLmRlbGV0ZU9uZSh7IHVzZXI6IGNvcHkuX2lkIH0pO1xuICAgICAgICAgICAgICAgIGxldCByZXNwb25zZSA9IHsgbWVzc2FnZTogYFVzZXIgd2l0aCBpZCBvZiAke2NvcHkuX2lkfSBhbmQgYWxsIGFzc29jaWF0ZWQgZGF0YSBzdWNjZXNzZnVsbHkgcmVtb3ZlZCFgLCBjb2RlOiAnUkVNT1ZFRCcgfTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24ocmVzcG9uc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgICAgICAgIC5zdGF0dXMoNDAxKVxuICAgICAgICAgICAgICAgIC5qc29uKHsgZXJyb3I6ICdNaXNzaW5nIHJlcXVpcmVkIGhlYWRlciBhY2Nlc3NUb2tlbi4nLCBjb2RlOiAnTk9UX0FVVEgnIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNcbiAgICAgICAgICAgIC5zdGF0dXMoNDIyKVxuICAgICAgICAgICAgLmpzb24oeyBlcnJvcjogJ01pc3NpbmcgcmVxdWlyZWQgcGFyYW1ldGVyLicsIGNvZGU6ICdJTlZBTElEX1BBUkFNUycgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgdXBkYXRlKHJlcSwgcmVzKSB7XG4gICAgICAgIGwuaW5mbygnVXNlcnNTZXJ2aWNlLnVwZGF0ZSgpJyk7XG4gICAgICAgIGNvbnN0IHVzZXJuYW1lUmVnZXggPSAvXlthLXowLTlfXSskL2k7XG4gICAgICAgIGlmIChyZXEuYm9keSAmJlxuICAgICAgICAgICAgKChyZXEuYm9keS51c2VybmFtZSAmJiByZXEuYm9keS51c2VybmFtZS5sZW5ndGggPiAyMCkgfHxcbiAgICAgICAgICAgICAgICAocmVxLmJvZHkucGFzc3dvcmQgJiYgcmVxLmJvZHkucGFzc3dvcmQubGVuZ3RoID4gMjApKSkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgICAgICAgIC5zdGF0dXMoNDIyKVxuICAgICAgICAgICAgICAgIC5qc29uKHsgZXJyb3I6ICdPbmUgb2YgdGhlIHBhcmFtZXRlcnMgaXMgdG9vIGxvbmchIEtlZXAgdW5kZXIgMjAgY2hhcmFjdGVycyEnLCBjb2RlOiAnVE9PX0xPTkcnIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXEuYm9keSAmJiAocmVxLmJvZHkudXNlcm5hbWUgfHwgcmVxLmJvZHkucGFzc3dvcmQpKSB7XG4gICAgICAgICAgICBpZiAocmVxLmhlYWRlcnMuYWNjZXNzdG9rZW4gfHwgcmVxLmNvb2tpZXMuYWNjZXNzdG9rZW4pIHtcbiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgTWVTZXJ2aWNlLm1lKHJlcSwgcmVzKTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgRXJyb3IgJiYgJ2NvZGUnIGluIHJlc3VsdCAmJiByZXN1bHQuY29kZSA9PT0gJ05PVF9BVVRIJykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24ocmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGwuZXJyb3IocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgICAgICAgICAgICAgICAgLnN0YXR1cyg1MDApXG4gICAgICAgICAgICAgICAgICAgICAgICAuanNvbih7IGVycm9yOiAnQW4gaW50ZXJuYWwgc2VydmVyIGVycm9yIG9jY3VyZWQhJywgY29kZTogJ0lOVEVSTkFMJyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHJlcS5ib2R5LnVzZXJuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdXNlcm5hbWVSZWdleC50ZXN0KHJlcS5ib2R5LnVzZXJuYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zdGF0dXMoNDIyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5qc29uKHsgZXJyb3I6ICdVc2VybmFtZSBpcyBpbnZhbGlkISBPbmx5IGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzIGFuZCB1bnNlcnNjb3JlIGFsbG93ZWQhJywgY29kZTogJ0lOVkFMSURfVVNFUk5BTUUnIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC51c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVxLmJvZHkucGFzc3dvcmQpIHJlc3VsdC5wYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgICAgICAgICAgICAgIGxldCBzZWNvbmRSZXN1bHQgPSBhd2FpdCByZXN1bHRcbiAgICAgICAgICAgICAgICAgICAgLnNhdmUoKVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4gZXJyb3IpO1xuICAgICAgICAgICAgICAgIGlmIChzZWNvbmRSZXN1bHQgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJ2NvZGUnIGluIHNlY29uZFJlc3VsdCAmJiBzZWNvbmRSZXN1bHQuY29kZSA9PT0gJ05PVF9FWElTVCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc3RhdHVzKDQwNClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuanNvbih7IGVycm9yOiBzZWNvbmRSZXN1bHQuZXJyb3IsIGNvZGU6IHNlY29uZFJlc3VsdC5jb2RlIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGwuZXJyb3IocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgICAgICAgICAgICAgICAgLnN0YXR1cyg1MDApXG4gICAgICAgICAgICAgICAgICAgICAgICAuanNvbih7IGVycm9yOiAnQW4gaW50ZXJuYWwgc2VydmVyIGVycm9yIG9jY3VyZWQhJywgY29kZTogJ0lOVEVSTkFMJyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHNlY29uZFJlc3VsdCBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWNvbmRSZXN1bHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBjb3B5ID0gc2Vjb25kUmVzdWx0LnRvT2JqZWN0KCk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGNvcHkucGFzc3dvcmQ7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKGNvcHkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgICAgICAgIC5zdGF0dXMoNDAxKVxuICAgICAgICAgICAgICAgIC5qc29uKHsgZXJyb3I6ICdNaXNzaW5nIHJlcXVpcmVkIGhlYWRlciBhY2Nlc3NUb2tlbi4nLCBjb2RlOiAnTk9UX0FVVEgnIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNcbiAgICAgICAgICAgIC5zdGF0dXMoNDIyKVxuICAgICAgICAgICAgLmpzb24oeyBlcnJvcjogJ01pc3NpbmcgcmVxdWlyZWQgcGFyYW1ldGVyLicsIGNvZGU6ICdJTlZBTElEX1BBUkFNUycgfSk7XG4gICAgfVxufVxuZXhwb3J0IGRlZmF1bHQgbmV3IENvbnRyb2xsZXIoKTtcbiJdfQ==